#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2026 Alfred Jean LLC
#
# Initialize a worktree with cached dependencies from the main checkout.
# Used with v0's V0_WORKTREE_INIT hook to avoid re-downloading bats libraries.
#
# Environment:
#   V0_CHECKOUT_DIR - Path to the main project checkout
#   V0_WORKTREE_DIR - Path to the new worktree
#
# Usage in .v0.rc:
#   V0_WORKTREE_INIT='scripts/init-worktree'

set -euo pipefail

# Allow running standalone (uses git to find roots)
if [ -z "${V0_CHECKOUT_DIR:-}" ]; then
    V0_CHECKOUT_DIR="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
fi

if [ -z "${V0_WORKTREE_DIR:-}" ]; then
    V0_WORKTREE_DIR="$(pwd)"
fi

BATS_SRC="$V0_CHECKOUT_DIR/checks/specs/bats"
BATS_DST="$V0_WORKTREE_DIR/checks/specs/bats"

# Install bats in main checkout if not present
if [ ! -d "$BATS_SRC/bats-core" ]; then
    if [ -x "$BATS_SRC/install.sh" ]; then
        echo "Installing bats libraries in main checkout..."
        "$BATS_SRC/install.sh"
    else
        echo "Warning: bats install.sh not found at $BATS_SRC/install.sh"
        exit 0
    fi
fi

# Copy to worktree if not already present
if [ ! -d "$BATS_DST/bats-core" ]; then
    echo "Copying bats libraries to worktree..."
    mkdir -p "$BATS_DST"
    cp -r "$BATS_SRC/bats-core" "$BATS_DST/"
    cp -r "$BATS_SRC/bats-support" "$BATS_DST/"
    cp -r "$BATS_SRC/bats-assert" "$BATS_DST/"
    echo "Bats libraries copied."
fi
