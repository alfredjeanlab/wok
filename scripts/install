#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2026 Alfred Jean LLC
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"
INSTALL_DIR="$HOME/.local/bin"

# Ensure install directory exists
mkdir -p "$INSTALL_DIR"

# Build wok CLI
echo "Building wok..."
cd "$ROOT_DIR"
cargo build --release -p wok

# Install to ~/.local/bin/
echo "Installing to $INSTALL_DIR/wok..."
/bin/cp "$ROOT_DIR/target/release/wok" "$INSTALL_DIR/wok"

# Re-sign the binary after copying (required on macOS for adhoc-signed binaries)
if [[ "$(uname)" == "Darwin" ]]; then
    codesign --force --sign - "$INSTALL_DIR/wok"
fi

# Create wk symlink
echo "Creating symlink $INSTALL_DIR/wk -> wok..."
ln -sf wok "$INSTALL_DIR/wk"

# Install shell completions (idempotent)
install_completions() {
    local wok="${INSTALL_DIR}/wok"
    local marker="# wok-shell-completion"
    local data_dir="${XDG_DATA_HOME:-$HOME/.local/share}/wok/completions"

    # Bash
    if command -v bash &> /dev/null; then
        local rc=""
        if [[ -f "$HOME/.bashrc" ]]; then
            rc="$HOME/.bashrc"
        elif [[ -f "$HOME/.bash_profile" ]]; then
            rc="$HOME/.bash_profile"
        fi
        if [[ -n "$rc" ]] && ! grep -q "$marker" "$rc"; then
            mkdir -p "$data_dir"
            "$wok" completion bash > "$data_dir/wok.bash"
            printf '\n%s\n[ -f "%s" ] && source "%s"\n' \
                "$marker" "$data_dir/wok.bash" "$data_dir/wok.bash" >> "$rc"
            echo "Installed bash completions (source: $rc)"
        fi
    fi

    # Zsh
    if command -v zsh &> /dev/null; then
        if [[ -f "$HOME/.zshrc" ]] && ! grep -q "$marker" "$HOME/.zshrc"; then
            mkdir -p "$data_dir"
            "$wok" completion zsh > "$data_dir/_wok"
            printf '\n%s\n[ -f "%s" ] && source "%s"\n' \
                "$marker" "$data_dir/_wok" "$data_dir/_wok" >> "$HOME/.zshrc"
            echo "Installed zsh completions (source: ~/.zshrc)"
        fi
    fi

    # Fish
    if command -v fish &> /dev/null; then
        local fish_dir="${XDG_CONFIG_HOME:-$HOME/.config}/fish/completions"
        if [[ ! -f "$fish_dir/wok.fish" ]]; then
            mkdir -p "$fish_dir"
            "$wok" completion fish > "$fish_dir/wok.fish"
            echo "Installed fish completions"
        fi
    fi
}

install_completions

echo "Done"
