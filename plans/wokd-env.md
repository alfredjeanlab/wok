# Plan: Centralized `env.rs` Module for the Daemon Crate

## Overview

Add a centralized `env.rs` module to `crates/daemon/` that serves as the single source of truth for all runtime environment variables. A `build.rs` script generates constants for env var names, and `env.rs` provides typed accessor functions. Update `main.rs` to use these accessors instead of direct `std::env::var()` calls.

## Project Structure

Files to create or modify:

```
crates/daemon/
├── build.rs              # NEW — generates env var name constants
├── src/
│   ├── env.rs            # NEW — typed accessors for env vars
│   └── main.rs           # MODIFY — use mod env instead of direct std::env::var()
```

## Dependencies

No new external dependencies. Uses only `std::env`, `std::path::PathBuf`, and the existing `dirs` crate (already in `Cargo.toml`).

## Implementation Phases

### Phase 1: Create `build.rs` to generate env var name constants

**File:** `crates/daemon/build.rs`

1. Create `build.rs` that writes a generated file containing `&str` constants for each env var name:

```rust
// crates/daemon/build.rs
use std::env;
use std::fs;
use std::path::Path;

fn main() {
    let out_dir = env::var("OUT_DIR").unwrap();
    let dest_path = Path::new(&out_dir).join("env_names.rs");

    let contents = r#"
/// Environment variable: override the wok state directory.
pub const WOK_STATE_DIR: &str = "WOK_STATE_DIR";

/// Environment variable: XDG base directory for state data.
pub const XDG_STATE_HOME: &str = "XDG_STATE_HOME";

/// Environment variable: controls log level filtering (used by tracing-subscriber).
pub const RUST_LOG: &str = "RUST_LOG";
"#;

    fs::write(&dest_path, contents).expect("failed to write env_names.rs");
}
```

**Milestone:** `cargo build -p wokd` succeeds and generates `env_names.rs` in `OUT_DIR`.

### Phase 2: Create `env.rs` with typed accessors

**File:** `crates/daemon/src/env.rs`

1. Create `env.rs` that includes the generated constants and provides typed accessor functions:

```rust
// crates/daemon/src/env.rs

//! Centralized environment variable definitions and accessors for wokd.
//!
//! All runtime env vars are defined here. Constants are generated by `build.rs`.

use std::path::PathBuf;

/// Generated env var name constants.
mod names {
    include!(concat!(env!("OUT_DIR"), "/env_names.rs"));
}

pub use names::*;

/// Returns the value of `WOK_STATE_DIR` as a `PathBuf`, if set.
///
/// When set, this overrides the default state directory location.
pub fn state_dir() -> Option<PathBuf> {
    std::env::var(names::WOK_STATE_DIR).ok().map(PathBuf::from)
}

/// Returns the value of `XDG_STATE_HOME` as a `PathBuf`, if set.
///
/// Used as a fallback when `WOK_STATE_DIR` is not set.
/// The wok state directory is `$XDG_STATE_HOME/wok`.
pub fn xdg_state_home() -> Option<PathBuf> {
    std::env::var(names::XDG_STATE_HOME).ok().map(PathBuf::from)
}
```

Note: `RUST_LOG` gets only a constant (re-exported from `names`), no accessor — tracing-subscriber reads it directly via `EnvFilter::try_from_default_env()`.

**Milestone:** `cargo check -p wokd` passes with the new module.

### Phase 3: Update `main.rs` to use `env.rs`

**File:** `crates/daemon/src/main.rs`

1. Add `mod env;` declaration alongside the existing `mod ipc;`.

2. Replace the two `std::env::var()` calls in `parse_state_dir` with the new accessors:

Before:
```rust
fn parse_state_dir(args: &[String]) -> PathBuf {
    // ...arg parsing...
    if let Ok(dir) = std::env::var("WOK_STATE_DIR") {
        return PathBuf::from(dir);
    }
    if let Ok(dir) = std::env::var("XDG_STATE_HOME") {
        return PathBuf::from(dir).join("wok");
    }
    // ...fallback...
}
```

After:
```rust
fn parse_state_dir(args: &[String]) -> PathBuf {
    // ...arg parsing...
    if let Some(dir) = env::state_dir() {
        return dir;
    }
    if let Some(dir) = env::xdg_state_home() {
        return dir.join("wok");
    }
    // ...fallback...
}
```

3. Leave `env!("CARGO_PKG_VERSION")` as-is — it's a compile-time macro, not a runtime env var.

**Milestone:** `cargo check -p wokd` passes; behavior is unchanged.

### Phase 4: Validate

1. Run `make check-fast` (fmt, clippy, check, build, test).
2. Run `make spec` to verify no behavioral regressions.

**Milestone:** All checks and specs pass.

## Key Implementation Details

- **`build.rs` scope:** The build script generates only string constants for env var names. This keeps the generated code trivial and the build script easy to maintain. The typed logic lives in hand-written `env.rs`.

- **`include!` pattern:** `env.rs` uses `include!(concat!(env!("OUT_DIR"), "/env_names.rs"))` inside a `mod names` block, then re-exports the constants with `pub use names::*`. This keeps the generated code isolated and the module's public API clean.

- **No accessor for `RUST_LOG`:** tracing-subscriber reads `RUST_LOG` internally via `EnvFilter::try_from_default_env()`. Wrapping it in an accessor would be unused. The constant is still exported so callers can reference the name if needed (e.g., in docs or error messages).

- **Lint compliance:** The daemon crate forbids `unsafe_code` and denies `unwrap_used`, `expect_used`, and `panic`. The `build.rs` script runs at build time (not under these lints), so `unwrap()`/`expect()` are fine there. The runtime `env.rs` code uses only `.ok().map()`, which is compliant.

- **`dirs` crate stays in `main.rs`:** The `dirs::home_dir()` fallback remains in `parse_state_dir` rather than moving into `env.rs`, since it's not an env var — it's a system directory lookup used as a last resort.

## Verification Plan

1. **Build check:** `cargo build -p wokd` succeeds, confirming `build.rs` generates valid code
2. **Lint check:** `cargo clippy -p wokd -- -D warnings` passes
3. **Format check:** `cargo fmt --check` passes
4. **Test check:** `cargo test -p wokd` passes (existing tests still work)
5. **Spec check:** `make spec` passes (no behavioral regression)
6. **Full validation:** `make check-fast` passes all checks
